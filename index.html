<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>genBarcode tool (EAN-13)</title>

    <link
        href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP:wght@400;600&family=JetBrains+Mono:wght@400;600&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --font-jp: "IBM Plex Sans JP", "Noto Sans JP", "Hiragino Sans", "Yu Gothic", Meiryo, system-ui, sans-serif;
            --font-mono: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;

            /* デフォルト（M=5列固定） */
            --cols: 5;
            --card-w: 240px;
            /* Mを少し小さく */
            --row-gap: 34px;
            --col-gap: 30px;

            /* S用（auto-fit）最小幅 */
            --s-min: 180px;

            /* バッジ（ナンバリング） */
            --badge-font: 14px;
            --badge-pad-y: 3px;
            --badge-pad-x: 8px;

            --badge-bg: #000;
            --badge-fg: #fff;
            --navy: #123c8c;
        }

        body {
            font-family: var(--font-jp);
            line-height: 1.5;
            margin: 20px;
        }

        h1 {
            font-size: 22px;
            margin: 0 0 6px;
            text-align: center;
        }

        /* 追加：ヘッダ直下のサブヘッダ（左=クレジット / 右=GitHubリンク） */
        .subhead {
            max-width: 980px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .credit {
            font-size: 12px;
            color: #777;
        }

        .ghlink {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            font-size: 13px;
            color: #333;
            text-decoration: none;
        }

        .ghlink:hover {
            text-decoration: underline;
        }

        .ghlink svg {
            width: 18px;
            height: 18px;
            fill: #222;
            display: block;
        }

        #panel {
            background: #f7f7f9;
            border: 1px solid #ddd;
            padding: 14px;
            border-radius: 10px;
            max-width: 980px;
            margin: 0 auto;
        }

        #barcode_input {
            width: 100%;
            height: 180px;
            font-family: var(--font-mono);
            font-variant-numeric: tabular-nums;
            font-feature-settings: "zero" 1;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            margin: 10px 0 6px;
            flex-wrap: wrap;
        }

        .btn {
            appearance: none;
            border: 1px solid #111;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn.go {
            background: #111;
            color: #fff;
        }

        .btn.go:active {
            transform: translateY(1px);
        }

        .btn.clear {
            background: #fff;
            color: #111;
            border: 1px solid #111;
        }

        .sizes {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: auto;
        }

        .sizes label {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            font-size: 13px;
        }

        #status {
            margin-top: 6px;
            color: #333;
        }

        .statLead {
            font-size: 15px;
            margin-bottom: 2px;
        }

        .statLead .count-in {
            font-weight: 700;
            color: #000;
            font-size: 16px;
        }

        .statLead .count-ok {
            font-weight: 700;
            color: var(--navy);
            font-size: 16px;
        }

        .summary {
            margin-left: 1.25em;
            font-size: 13px;
        }

        .indent-list {
            margin-left: 1.25em;
        }

        code.bad {
            color: #b00020;
        }

        /* 固定列（M/L） */
        #keeper {
            display: grid;
            grid-template-columns: repeat(var(--cols), 1fr);
            gap: var(--row-gap) var(--col-gap);
            justify-content: center;
            justify-items: center;
            align-items: start;
            max-width: 1600px;
            margin: 18px auto 0;
        }

        /* S：レスポンシブ列（auto-fit） */
        #keeper.resp {
            grid-template-columns: repeat(auto-fit, minmax(var(--s-min), 1fr));
            justify-items: stretch;
            max-width: none;
            /* 制限解除 */
        }

        .bcdiv {
            position: relative;
            width: var(--card-w);
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 0 0 1px #eee inset;
            text-align: center;
        }

        .bcdiv svg {
            display: block;
            width: 100%;
            height: auto;
            margin: 0 auto 10px;
        }

        .badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: var(--badge-bg);
            color: var(--badge-fg);
            font-family: var(--font-mono);
            font-variant-numeric: tabular-nums;
            font-feature-settings: "zero" 1;
            font-size: var(--badge-font);
            line-height: 1;
            padding: var(--badge-pad-y) var(--badge-pad-x);
            border-radius: 6px;
            opacity: .9;
        }

        @media print {

            .subhead,
            #panel,
            #status {
                display: none !important;
            }

            body {
                margin: 8mm;
            }

            .bcdiv {
                page-break-inside: avoid;
            }
        }
    </style>
</head>

<body>
    <h1>genBarcodeTool (EAN-13)</h1>

    <!-- クレジット＆GitHubリンク -->
    <div class="subhead">
        <a class="credit" href="https://www.gion-deliveryservice.co.jp/" target="_blank">GION DELIVERY SERVICE KK
            2025</a>
        <a class="ghlink" href="https://github.com/totkd/EAN13" target="_blank" rel="noopener noreferrer"
            aria-label="GitHub Repository">
            <!-- Octocat mark（MITライセンスのOcticonsパス） -->
            <svg viewBox="0 0 16 16" aria-hidden="true">
                <path
                    d="M8 0C3.58 0 0 3.58 0 8a8 8 0 0 0 5.47 7.59c.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.5-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.01.08-2.11 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.91.08 2.11.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.53.73.53 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
            </svg>
            <span>GitHub</span>
        </a>
    </div>

    <div id="panel">
        <textarea id="barcode_input" placeholder="例：&#10;2701112223334&#10;2798887776665"></textarea>

        <div class="controls">
            <button class="btn go" id="goBtn">Go!</button>
            <button class="btn clear" id="clearBtn">CLEAR</button>

            <div class="sizes" role="radiogroup" aria-label="サイズ">
                <label><input type="radio" name="sz" value="S">S</label>
                <label><input type="radio" name="sz" value="M" checked>M</label>
                <label><input type="radio" name="sz" value="L">L</label>
            </div>
        </div>

        <div id="status" aria-live="polite"></div>
    </div>

    <div id="keeper"></div>

    <script>
        /* ====== EAN-13 encode & render（前回仕様） ====== */
        const MODULE_PX = 2, QUIET_MODULES = 11, NORMAL_BAR_H = 92, GUARD_EXTEND = 12, HR_FONT_SIZE = 20;
        const HR_FONT_FAMILY = '"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
        const L = ["0001101", "0011001", "0010011", "0111101", "0100011", "0110001", "0101111", "0111011", "0110111", "0001011"];
        const G = ["0100111", "0110011", "0011011", "0100001", "0011101", "0111001", "0000101", "0010001", "0001001", "0010111"];
        const R = ["1110010", "1100110", "1101100", "1000010", "1011100", "1001110", "1010000", "1000100", "1001000", "1110100"];
        const PARITY = ["AAAAAA", "AABABB", "AABBAB", "AABBBA", "ABAABB", "ABBAAB", "ABBBAA", "ABABAB", "ABABBA", "ABBABA"];
        function calcCheckDigit12(d12) { let s = 0; for (let i = 0; i < 12; i++) { const n = d12.charCodeAt(i) - 48; s += (i % 2 === 0) ? n : n * 3; } return (10 - (s % 10)) % 10; }
        function isValidEAN13(d13) { return /^\d{13}$/.test(d13) && calcCheckDigit12(d13.slice(0, 12)) === (d13.charCodeAt(12) - 48); }
        function encodeEAN13Bits(d13) { const f = d13.charCodeAt(0) - 48, p = PARITY[f]; let b = "101"; for (let i = 1; i <= 6; i++) { const d = d13.charCodeAt(i) - 48; b += (p[i - 1] === 'A') ? L[d] : G[d] } b += "01010"; for (let i = 7; i <= 12; i++) { const d = d13.charCodeAt(i) - 48; b += R[d] } return b + "101"; }
        function isGuardIndex(i) { return (i < 3) || (i >= 45 && i < 50) || (i >= 92); }
        function renderEAN13SVG(d13) {
            const bits = encodeEAN13Bits(d13), total = 95 + QUIET_MODULES * 2, w = total * MODULE_PX, h = NORMAL_BAR_H + GUARD_EXTEND + 28;
            const svgNS = "http://www.w3.org/2000/svg"; const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("viewBox", `0 0 ${w} ${h}`); svg.setAttribute("preserveAspectRatio", "xMidYMin meet");
            const bg = document.createElementNS(svgNS, "rect"); bg.setAttribute("x", 0); bg.setAttribute("y", 0);
            bg.setAttribute("width", w); bg.setAttribute("height", h); bg.setAttribute("fill", "#fff"); svg.appendChild(bg);
            let run = 0, rs = 0;
            for (let i = 0; i < 95; i++) {
                const one = (bits.charCodeAt(i) === 49); if (one) { if (run === 0) rs = i; run++; } if (!one || i === 94) {
                    if (run > 0) {
                        const rect = document.createElementNS(svgNS, "rect");
                        rect.setAttribute("x", (QUIET_MODULES + rs) * MODULE_PX); rect.setAttribute("y", 0);
                        rect.setAttribute("width", (i + (one ? 1 : 0) - rs) * MODULE_PX); rect.setAttribute("height", isGuardIndex(rs) ? NORMAL_BAR_H + GUARD_EXTEND : NORMAL_BAR_H);
                        rect.setAttribute("fill", "#000"); svg.appendChild(rect); run = 0;
                    }
                }
            }
            const human = `${d13[0]} ${d13.slice(1, 7)} ${d13.slice(7)}`;
            const text = document.createElementNS(svgNS, "text"); text.setAttribute("x", w / 2); text.setAttribute("y", NORMAL_BAR_H + GUARD_EXTEND + 20);
            text.setAttribute("text-anchor", "middle"); text.setAttribute("font-family", HR_FONT_FAMILY);
            text.setAttribute("font-size", String(HR_FONT_SIZE)); text.setAttribute("style", "font-variant-numeric:tabular-nums; font-feature-settings:'zero' 1;");
            text.textContent = human; svg.appendChild(text); return svg;
        }

        /* ====== UI（重複除外・サイズ切替） ====== */
        const inputEl = document.getElementById('barcode_input');
        const goBtn = document.getElementById('goBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusEl = document.getElementById('status');
        const keeperEl = document.getElementById('keeper');
        const sizeRadios = [...document.querySelectorAll('input[name="sz"]')];

        sizeRadios.forEach(r => r.addEventListener('change', () => applySize(r.value)));
        applySize(document.querySelector('input[name="sz"]:checked').value);

        function applySize(sz) {
            const root = document.documentElement.style;
            if (sz === 'S') {
                keeperEl.classList.add('resp');
                root.setProperty('--card-w', '100%');        // カラム幅いっぱい
                root.setProperty('--s-min', '180px');
                root.setProperty('--row-gap', '28px');
                root.setProperty('--col-gap', '24px');
                root.setProperty('--badge-font', '12px');
                root.setProperty('--badge-pad-y', '2px');
                root.setProperty('--badge-pad-x', '6px');
            } else if (sz === 'L') {
                keeperEl.classList.remove('resp');
                root.setProperty('--cols', '3');
                root.setProperty('--card-w', '360px');
                root.setProperty('--row-gap', '48px');
                root.setProperty('--col-gap', '40px');
                root.setProperty('--badge-font', '16px');
                root.setProperty('--badge-pad-y', '4px');
                root.setProperty('--badge-pad-x', '9px');
            } else { // M
                keeperEl.classList.remove('resp');
                root.setProperty('--cols', '5');
                root.setProperty('--card-w', '240px');
                root.setProperty('--row-gap', '34px');
                root.setProperty('--col-gap', '30px');
                root.setProperty('--badge-font', '14px');
                root.setProperty('--badge-pad-y', '3px');
                root.setProperty('--badge-pad-x', '8px');
            }
        }

        goBtn.addEventListener('click', generateAll);
        clearBtn.addEventListener('click', () => { inputEl.value = ""; statusEl.textContent = ""; keeperEl.innerHTML = ""; inputEl.focus(); });

        function calcCheckDigit12(d12) { let s = 0; for (let i = 0; i < 12; i++) { const n = d12.charCodeAt(i) - 48; s += (i % 2 === 0) ? n : n * 3; } return (10 - (s % 10)) % 10; }
        function isValidEAN13(d13) { return /^\d{13}$/.test(d13) && calcCheckDigit12(d13.slice(0, 12)) === (d13.charCodeAt(12) - 48); }

        function generateAll() {
            keeperEl.innerHTML = ""; statusEl.textContent = "";

            const lines = inputEl.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
            const totalInput = lines.length;
            if (totalInput === 0) { statusEl.textContent = "入力がありません。"; return; }
            if (totalInput >= 200) {
                const ok = confirm(`${totalInput}件入力されています。OKをクリックすると続行しますが、少し時間がかかります。200件ずつくらいがちょうどいいです。キャンセルを押すと何もせずに戻ります。`);
                if (!ok) return;
            }

            const normalized = [], fails = [], suggests = [];
            for (const original of lines) {
                const digitsOnly = original.replace(/\D+/g, "");
                if (digitsOnly.length === 12) {
                    normalized.push({ original, d13: digitsOnly + calcCheckDigit12(digitsOnly) });
                } else if (digitsOnly.length === 13) {
                    if (!isValidEAN13(digitsOnly)) {
                        const b12 = digitsOnly.slice(0, 12);
                        if (/^\d{12}$/.test(b12)) { suggests.push({ bad: original, maybe: b12 + calcCheckDigit12(b12) }); }
                        fails.push(original); normalized.push({ original, d13: null });
                    } else {
                        normalized.push({ original, d13: digitsOnly });
                    }
                } else {
                    fails.push(original); normalized.push({ original, d13: null });
                }
            }

            const seen = new Set(), dupsSet = new Set(), uniq = [];
            for (const rec of normalized) {
                if (!rec.d13) continue;
                if (seen.has(rec.d13)) { dupsSet.add(rec.d13); }
                else { seen.add(rec.d13); uniq.push(rec); }
            }

            // 描画
            let okCount = 0;
            for (const rec of uniq) {
                try {
                    const wrap = document.createElement('div'); wrap.className = 'bcdiv';
                    const badge = document.createElement('div'); badge.className = 'badge'; badge.textContent = String(okCount + 1); wrap.appendChild(badge);
                    wrap.appendChild(renderEAN13SVG(rec.d13));
                    keeperEl.appendChild(wrap); okCount++;
                } catch (e) { fails.push(rec.original); }
            }

            // ステータス
            const frag = document.createDocumentFragment();
            const lead = document.createElement('div'); lead.className = 'statLead';
            const inSpan = document.createElement('span'); inSpan.className = 'count-in'; inSpan.textContent = `${totalInput}件`;
            const okSpan = document.createElement('span'); okSpan.className = 'count-ok'; okSpan.textContent = `${okCount}件`;
            lead.appendChild(inSpan); lead.appendChild(document.createTextNode('に対して')); lead.appendChild(okSpan); lead.appendChild(document.createTextNode('生成しました。'));
            frag.appendChild(lead);

            const summary = document.createElement('div'); summary.className = 'summary';
            summary.appendChild(document.createTextNode(`入力　${totalInput}件`)); summary.appendChild(document.createElement('br'));
            summary.appendChild(document.createTextNode(`生成　${okCount}件`));
            if (dupsSet.size > 0) { summary.appendChild(document.createElement('br')); summary.appendChild(document.createTextNode(`重複　${dupsSet.size}件`)); }
            if (fails.length > 0) { summary.appendChild(document.createElement('br')); summary.appendChild(document.createTextNode(`失敗　${fails.length}件`)); }
            frag.appendChild(summary);

            if (dupsSet.size > 0) {
                const t = document.createElement('div'); t.textContent = "重複していた数値は次の通り："; frag.appendChild(t);
                const list = document.createElement('div'); list.className = 'indent-list';
                for (const d of dupsSet) { const line = document.createElement('div'); const code = document.createElement('code'); code.textContent = d; line.appendChild(code); list.appendChild(line); }
                frag.appendChild(list);
            }

            if (fails.length > 0) {
                const t = document.createElement('div'); t.textContent = "生成に失敗した数値は次の通り："; frag.appendChild(t);
                const list = document.createElement('div'); list.className = 'indent-list';
                for (const bad of fails) {
                    const row = document.createElement('div');
                    const sug = suggests.find(s => s.bad === bad);
                    if (sug && sug.maybe && sug.maybe !== bad.replace(/\D+/g, "")) {
                        const badCode = document.createElement('code'); badCode.className = 'bad'; badCode.textContent = bad;
                        const arrow = document.createTextNode('　→　もしかして　');
                        const maybe = document.createElement('code'); maybe.textContent = sug.maybe;
                        row.appendChild(badCode); row.appendChild(arrow); row.appendChild(maybe);
                    } else {
                        const code = document.createElement('code'); code.className = 'bad'; code.textContent = bad; row.appendChild(code);
                    }
                    list.appendChild(row);
                }
                frag.appendChild(list);
            }

            statusEl.innerHTML = ""; statusEl.appendChild(frag);
        }

        /* レンダラ（上で使用） */
        function renderEAN13SVG(d13) {
            const bits = encodeEAN13Bits(d13), total = 95 + QUIET_MODULES * 2, w = total * MODULE_PX, h = NORMAL_BAR_H + GUARD_EXTEND + 28;
            const svgNS = "http://www.w3.org/2000/svg"; const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("viewBox", `0 0 ${w} ${h}`); svg.setAttribute("preserveAspectRatio", "xMidYMin meet");
            const bg = document.createElementNS(svgNS, "rect"); bg.setAttribute("x", 0); bg.setAttribute("y", 0);
            bg.setAttribute("width", w); bg.setAttribute("height", h); bg.setAttribute("fill", "#fff"); svg.appendChild(bg);
            let run = 0, rs = 0;
            for (let i = 0; i < 95; i++) {
                const one = (bits.charCodeAt(i) === 49);
                if (one) { if (run === 0) rs = i; run++; }
                if (!one || i === 94) {
                    if (run > 0) {
                        const rect = document.createElementNS(svgNS, "rect");
                        rect.setAttribute("x", (QUIET_MODULES + rs) * MODULE_PX);
                        rect.setAttribute("y", 0);
                        rect.setAttribute("width", (i + (one ? 1 : 0) - rs) * MODULE_PX);
                        rect.setAttribute("height", isGuardIndex(rs) ? NORMAL_BAR_H + GUARD_EXTEND : NORMAL_BAR_H);
                        rect.setAttribute("fill", "#000");
                        svg.appendChild(rect);
                        run = 0;
                    }
                }
            }
            const human = `${d13[0]} ${d13.slice(1, 7)} ${d13.slice(7)}`;
            const text = document.createElementNS(svgNS, "text");
            text.setAttribute("x", w / 2); text.setAttribute("y", NORMAL_BAR_H + GUARD_EXTEND + 20);
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("font-family", HR_FONT_FAMILY);
            text.setAttribute("font-size", String(HR_FONT_SIZE));
            text.setAttribute("style", "font-variant-numeric:tabular-nums; font-feature-settings:'zero' 1;");
            text.textContent = human; svg.appendChild(text);
            return svg;
        }
    </script>
</body>

</html>